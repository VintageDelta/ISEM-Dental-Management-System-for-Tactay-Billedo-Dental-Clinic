{% extends "core/base.html" %}
{% block title %}Reports Dashboard{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="max-w-7xl mx-auto space-y-8">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <h1 class="text-2xl font-bold text-gray-800">
            Reports Dashboard
        </h1>

        <div class="flex flex-wrap items-center gap-2">

            <!-- Range Filters -->
            <a href="?range=daily" class="px-4 py-2 rounded text-sm font-medium
           {% if range_type == 'daily' %}bg-blue-600 text-white{% else %}bg-gray-200{% endif %}">
                Daily
            </a>

            <a href="?range=monthly" class="px-4 py-2 rounded text-sm font-medium
           {% if range_type == 'monthly' %}bg-blue-600 text-white{% else %}bg-gray-200{% endif %}">
                Monthly
            </a>

            <!-- Divider -->
            <div class="w-px h-6 bg-gray-300 mx-2"></div>

            <!-- Export Buttons -->
            <a href="{% url 'reports:export' %}?range={{ range_type }}&format=excel"
                class="group relative inline-flex items-center px-4 py-2 rounded bg-green-600 text-white text-sm font-medium hover:bg-green-700">
                Export Excel
                <span class="pointer-events-none absolute bottom-full mb-2
               opacity-0 scale-95
               group-hover:opacity-100 group-hover:scale-100
               transition-all duration-200
               whitespace-nowrap
               rounded bg-green-900 px-2 py-1
               text-xs text-green-100 shadow-lg">
                    Data & breakdowns
                </span>
            </a>

            <a href="{% url 'reports:export' %}?range={{ range_type }}&format=pdf"
                class="group relative inline-flex items-center px-4 py-2 rounded bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700">
                Export PDF
                <span class="pointer-events-none absolute bottom-full mb-2
               opacity-0 scale-95
               group-hover:opacity-100 group-hover:scale-100
               transition-all duration-200
               whitespace-nowrap
               rounded bg-indigo-900 px-2 py-1
               text-xs text-indigo-100 shadow-lg">
                    Charts & summary
                </span>
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="bg-white p-5 rounded shadow">
            <p class="text-sm text-gray-500">Completed Appointments</p>
            <p class="text-3xl font-bold text-green-600">{{ completed_appointments }}</p>
        </div>

        <div class="bg-white p-5 rounded shadow">
            <p class="text-sm text-gray-500">Total Patients</p>
            <p class="text-3xl font-bold">{{ total_patients }}</p>
        </div>

        <div class="bg-white p-5 rounded shadow">
            <p class="text-sm text-gray-500">Paid Revenue</p>
            <p class="text-3xl font-bold text-blue-600">â‚±{{ paid_revenue|floatformat:2 }}</p>
        </div>

        <div class="bg-white p-5 rounded shadow">
            <p class="text-sm text-gray-500">Low Stock Items</p>
            <p class="text-3xl font-bold text-yellow-600">{{ low_stock_count }}</p>
        </div>

        <div class="bg-white p-5 rounded shadow">
            <p class="text-sm text-gray-500">Expired Items</p>
            <p class="text-3xl font-bold text-red-600">{{ expired_item_count }}</p>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded shadow">
            <h2 class="font-semibold mb-4">Appointment Trend</h2>
            <canvas id="appointmentChart"></canvas>
        </div>

        <div class="bg-white p-6 rounded shadow">
            <h2 class="font-semibold mb-4">Patient Growth</h2>
            <canvas id="patientChart"></canvas>
        </div>

        <div class="bg-white p-6 rounded shadow">
            <h2 class="font-semibold mb-4">Paid Revenue Trend</h2>
            <canvas id="revenueChart"></canvas>
        </div>

        <div class="bg-white p-6 rounded shadow">
            <h2 class="font-semibold mb-4">Inventory by Category</h2>
            <canvas id="inventoryChart"></canvas>
        </div>
    </div>
</div>

<script>
    function createLineChart(id, labels, data, label, color) {
        new Chart(document.getElementById(id), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + "33",
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function createBarChart(id, labels, data, label) {
        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    createLineChart(
        "appointmentChart",
        {{ appointment_labels| safe }},
        {{ appointment_data| safe }},
        "Appointments",
        "#10b981"
    );

    createLineChart(
        "patientChart",
        {{ patient_labels| safe }},
        {{ patient_data| safe }},
        "New Patients",
        "#6366f1"
    );

    createLineChart(
        "revenueChart",
        {{ revenue_labels| safe }},
        {{ revenue_data| safe }},
        "Revenue",
        "#2563eb"
    );

    createBarChart(
        "inventoryChart",
        {{ inventory_category_labels| safe }},
        {{ inventory_category_data| safe }},
        "Items"
    );
</script>

<script>
    function setExportFormat(format) {
        const btn = document.getElementById("exportBtn");
        const baseUrl = "{% url 'reports:export' %}";
        btn.href = `${baseUrl}?range={{ range_type }}&format=${format}`;

        // Close dropdown
        document.getElementById('exportDropdown').classList.add('hidden');
    }
</script>
{% endblock %}