  {% extends "core/base.html" %} {% load static %} {% block content %}

  <!-- === TAB BUTTONS === -->
  <div class="flex items-center space-x-4 mb-6">
    <button
      id="medicalTab"
      class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium shadow hover:bg-blue-700 focus:outline-none"
    >
      Treatment History
    </button>
    <button
      id="financialTab"
      class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium shadow hover:bg-gray-300 focus:outline-none"
    >
      Billing History
    </button>
    <button
      id="odontogramTab"
      class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium shadow hover:bg-gray-300 focus:outline-none"
    >
      Odontogram
    </button>
    {% if user.is_staff or user.is_superuser %}
    <button
      id="add-medical-btn"
      class="items-center px-4 py-2 rounded-lg bg-green-600 text-white font-semibold shadow hover:bg-green-700 focus:outline-none"
    >
      + Add Record
    </button>
    <button
      id="add-financial-btn"
      class="hidden items-center px-4 py-2 rounded-lg bg-green-600 text-white font-semibold shadow hover:bg-green-700 focus:outline-none"
    >
      + Add Record
    </button>
    <button
    id="add-odontogram-btn"
    class="hidden items-center px-4 py-2 rounded-lg bg-green-600 text-white font-semibold shadow hover:bg-green-700 focus:outline-none"
  >
    + Add Record
  </button>
    {% endif %}
  </div>

  <!-- === MEDICAL TAB CONTENT === -->
  <div id="medicalContent" class="space-y-4">
    <div class="overflow-x-auto bg-white shadow rounded-lg">
      <table class="w-full min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Date</th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Dentist
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Reason
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Diagnosis
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Service
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Treatment
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Prescriptions
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for record in medical_history %}
          <tr class="hover:bg-gray-100">
            <td class="px-4 py-2">{{ record.date|date:"Y-m-d" }}</td>
            <td class="px-4 py-2">{{ record.dentist }}</td>
            <td class="px-4 py-2">{{ record.reason }}</td>
            <td class="px-4 py-2">{{ record.diagnosis }}</td>
            <td class="px-4 py-2">{{ record.service }}</td>
            <td class="px-4 py-2">{{ record.treatment }}</td>
            <td class="px-4 py-2">{{ record.prescriptions }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-4 py-6 text-center text-gray-500">
              No medical history records yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- === FINANCIAL TAB CONTENT === -->
  <div id="financialContent" class="space-y-4 hidden">
    <div class="overflow-x-auto bg-white shadow rounded-lg">
      <table class="w-full min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Number
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Date</th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Description
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Time</th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Type</th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Amount
            </th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">
              Balance
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for record in financial_history %}
          <tr class="hover:bg-gray-100">
            <td class="px-4 py-2">{{ record.number }}</td>
            <td class="px-4 py-2">{{ record.date|date:"Y-m-d" }}</td>
            <td class="px-4 py-2">{{ record.description }}</td>
            <td class="px-4 py-2">{{ record.time|time:"H:i" }}</td>
            <td class="px-4 py-2">{{ record.type }}</td>
            <td class="px-4 py-2">{{ record.amount }}</td>
            <td class="px-4 py-2">{{ record.balance }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-4 py-6 text-center text-gray-500">
              No financial history records yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- === ODONTOGRAM TAB CONTENT === -->
  <div id="odontogramContent" class="space-y-4 hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Odontogram -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4 text-center">Odontogram</h2>
        <div class="grid grid-cols-1 gap-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8">
          {% for tooth_num in tooth_num %}
          <button
            class="w-10 h-10 flex items-center justify-center border rounded hover:bg-blue-100 text-sm"
            onclick="selectTooth('{{ tooth_num }}')"
          >
            {{ tooth_num }}
          </button>
          {% endfor %}
        </div>
      </div>

      <!-- Show Selection-->
      <div class="bg-white rounded-lg shadow p-6">
        <div id="tooth-history">
          <p class="text-gray-500 text-center">
            Select a tooth to view its history
          </p>
        </div>
      </div>

    </div>
  </div>
  <!-- Add Record Popup -->
  <div
    id="modal-popup"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
  >
    <div
      id="popup-content"
      class="bg-white rounded-lg shadow-lg w-full max-w-lg max-h-[80vh] flex flex-col transform transition-all duration-200 opacity-0 scale-95"
    >
    <div class="px-6 pt-5 pb-3 border-b">
      <h2 class="text-lg font-semibold mb-4 text-center">Add Record</h2>
    </div>
     <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
      <!-- Medical History Form -->
      <div class="flex-1 overflow-y-auto pr-2">
      <form
        id="medicalForm" 
        method="post"
        action="{% url 'patient:add_medical_history' patient.id %}"
        class="space-y-3 hidden"
      >
        {% csrf_token %}
        <input
          type="date"
          name="date"
          placeholder="Date"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="dentist"
          placeholder="Dentist"
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="reason"
          placeholder="Reason"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="diagnosis"
          placeholder="Diagnosis"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="service"
          placeholder="Service"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="treatment"
          placeholder="Treatment"
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="prescriptions"
          placeholder="Prescriptions"
          class="w-full border rounded-md p-2 text-sm"
        />

        <div class="flex justify-end gap-2 pt-3">
          <button
            type="button"
            id="close-popup-btn"
            class="px-4 py-2 text-sm bg-gray-500 text-white rounded-md hover:bg-gray-600"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Save
          </button>
        </div>
      </form>
  <!-- Financial Form  -->
      <form
        id="financialForm"
        method="post"
        action="{% url 'patient:add_financial_history' patient.id %}"
        class="space-y-3 hidden"
      >
        {% csrf_token %}
        <input
          type="number"
          name="number"
          placeholder="Number"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="date"
          name="date" required
          placeholder="Date"
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="description" 
          placeholder="Description"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="time"
          name="time"
          placeholder="Time"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="text"
          name="type"
          placeholder="Type"
          required
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="number"
          name="amount"
          placeholder="Amount"
          class="w-full border rounded-md p-2 text-sm"
        />
        <input
          type="number"
          name="balance"
          placeholder="Balance"
          class="w-full border rounded-md p-2 text-sm"
        />
        <div class="flex justify-end gap-2 pt-3">
          <button
            type="button"
            id="close-popup-btn"
            class="px-4 py-2 text-sm bg-gray-500 text-white rounded-md hover:bg-gray-600"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Save
          </button>
        </div>
      </form>
      <!-- Odontogram Form -->
      <form
        id="odontogramForm"
        method="post"
        action="{% url 'patient:add_odontogram' patient.id %}"
        class="flex flex-col gap-3 h-full hidden"
      >
        {% csrf_token %}

        <div id="odontogram-records" class="space-y-4 overflow-y-auto pr-2">
          <!-- ONE RECORD TEMPLATE -->
          <div class="odontogram-record border rounded-md p-3 space-y-3">
            <input
              type="date"
              name="date_0"
              placeholder="Date of Operation"
              required
              class="w-full border rounded-md p-2 text-sm"
            />

            <label class="font-semibold">Tooth Number:</label>
            <!-- Check All-->
            <div class="flex items-center gap-2 mb-1 text-xs">
  <input
    type="checkbox"
    class="tooth-check-all rounded border-gray-300"
  />
  <span class="text-gray-600">Check all teeth</span>
</div>
            <div class="grid grid-cols-8 gap-2 max-h-40 overflow-y-auto mb-2">
              {% for tooth_num in tooth_num %}
              <label class="text-center text-sm">
                <input type="checkbox" name="tooth_number_0" value="{{ tooth_num }}" class="mr-1 tooth-checkbox">
                <span>{{ tooth_num }}</span>
              </label>
              {% endfor %}
            </div>

            <label class="font-semibold">Select Services:</label>
            <div class="border rounded-md p-2 max-h-40 overflow-y-auto space-y-1">
              {% for service in services %}
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="services_0" value="{{ service.id }}" class="rounded border-gray-300">
                <span>{{ service.service_name }}</span>
              </label>
              {% endfor %}
            </div>

            <!-- Dentist Name -->
            <select name="dentist_0" required class="w-full border rounded-md p-2 text-sm">
              <option value="" disabled selected>Select Dentist</option>
              {% for dentist in dentists %}
              <option value="{{ dentist.id }}">{{ dentist.name }}</option>
              {% endfor %}
            </select>

            <input
              type="text"
              name="status_0"
              placeholder="Status"
              required
              class="w-full border rounded-md p-2 text-sm"
            />

            <!-- Remove button for extra records -->
            <button
              type="button"
              class="remove-record hidden mt-2 text-xs text-red-600 hover:underline"
            >
              Remove this record
            </button>
          </div>
        </div>

        <div class="flex justify-between gap-2 pt-3 border-t mt-3 pt-3">
          <button
            type="button"
            id="add-more-odontogram"
            class="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700"
          >
            + Add More
          </button>

          <div class="flex gap-2">
            <button
              type="button"
              id="close-popup-btn"
              class="px-4 py-2 text-sm bg-gray-500 text-white rounded-md hover:bg-gray-600"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Save
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
    
  </div>



  {% endblock %} {% block extra_js %}
  <script src="{% static 'js/modal.js' %}"></script>

  <script>
    const medicalTab = document.getElementById("medicalTab");
    const financialTab = document.getElementById("financialTab");
    const medicalContent = document.getElementById("medicalContent");
    const financialContent = document.getElementById("financialContent");
    const odontogramTab = document.getElementById("odontogramTab");
    const odontogramContent = document.getElementById("odontogramContent"); 
    

    medicalTab.addEventListener("click", () => {
      medicalContent.classList.remove("hidden");
      financialContent.classList.add("hidden");
      odontogramContent.classList.add("hidden");

      odontogramTab.classList.replace("bg-blue-600", "bg-gray-200");
      odontogramTab.classList.replace("text-white", "text-gray-700");

      medicalTab.classList.replace("bg-gray-200", "bg-blue-600");
      medicalTab.classList.replace("text-gray-700", "text-white");

      financialTab.classList.replace("bg-blue-600", "bg-gray-200");
      financialTab.classList.replace("text-white", "text-gray-700");
    });

    financialTab.addEventListener("click", () => {
      financialContent.classList.remove("hidden");
      medicalContent.classList.add("hidden");
      odontogramContent.classList.add("hidden");

      odontogramTab.classList.replace("bg-blue-600", "bg-gray-200");
      odontogramTab.classList.replace("text-white", "text-gray-700");

      financialTab.classList.replace("bg-gray-200", "bg-blue-600");
      financialTab.classList.replace("text-gray-700", "text-white");

      medicalTab.classList.replace("bg-blue-600", "bg-gray-200");
      medicalTab.classList.replace("text-white", "text-gray-700");
    });

    odontogramTab.addEventListener("click", () => {
      odontogramContent.classList.remove("hidden");
      medicalContent.classList.add("hidden");
      financialContent.classList.add("hidden");

      odontogramTab.classList.replace("bg-gray-200", "bg-blue-600");
      odontogramTab.classList.replace("text-gray-700", "text-white");

      medicalTab.classList.replace("bg-blue-600", "bg-gray-200");
      medicalTab.classList.replace("text-white", "text-gray-700");

      financialTab.classList.replace("bg-blue-600", "bg-gray-200");
      financialTab.classList.replace("text-white", "text-gray-700");
    });
  </script>

  <script>
    const medicalUrl = "{% url 'patient:add_medical_history' patient.id %}";
    const financialUrl = "{% url 'patient:add_financial_history' patient.id %}";
    const odontogramUrl = "{% url 'patient:add_odontogram' patient.id %}";
  </script>
  <script>
    
</script>
 <script>
function selectTooth(tooth_num) {
  const patient_id = {{ patient.id }};
  
  // Highlight selected tooth
  document.querySelectorAll('.w-10').forEach(btn => {
    btn.classList.remove('bg-blue-500', 'text-white');
    btn.classList.add('border-gray-300','hover:bg-blue-100','text-black');
  });
  const currentBtn = document.querySelector(`button[onclick="selectTooth('${tooth_num}')"]`);
  currentBtn.classList.add('bg-blue-500','text-white');

  // Fetch tooth history
  fetch(`/dashboard/patient/${ patient_id }/odontogram/history/${tooth_num}/`)
      .then(response => response.json())
      .then(result => {
         console.log("RAW RESPONSE:", result);
         displayToothHistory(tooth_num, result.data)})
      .catch(error => console.error("Fetch Error:", error));
}


// Render tooth history
function displayToothHistory(tooth_num, data) {
    const historyDiv = document.getElementById("tooth-history");
    let html = `
      <h3 class="text-lg font-semibold text-center mb-3">Tooth ${tooth_num}</h3>
    `;

    if (data.length === 0) {
      historyDiv.innerHTML = html + `<p class="text-center text-gray-500">No records yet.</p>`
      return;
    }

    data.forEach(record => {
      html += `
        <div class="p-3 mb-2 border bg-gray-50 rounded">
          <p><strong>Date:</strong> ${record.date || "-"}</p>
          <p><strong>Dentist:</strong> ${record.dentist || "-"}</p>
          <p><strong>Status:</strong> ${record.status || "-"}</p>

          <p><strong>Services:</strong> 
            ${record.services &&  record.services.length > 0 
              ? record.services.join(", ")
              : "-" }
          </p>
        </div>`;
        console.log("SERVICES VALUE:", record.services); 
    });

    historyDiv.innerHTML = html;
}
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const recordsWrapper = document.getElementById("odontogram-records");
    const addMoreBtn = document.getElementById("add-more-odontogram");

    if (!recordsWrapper || !addMoreBtn) return;

    let recordIndex = 0; // highest index used

    function wireCheckAll(recordEl) {
      const checkAllBox = recordEl.querySelector(".tooth-check-all");
      const toothCheckboxes = recordEl.querySelectorAll(".tooth-checkbox");

      if (!checkAllBox) return;

      // remove existing listeners by cloning (simple reset)
      const newCheckAll = checkAllBox.cloneNode(true);
      checkAllBox.parentNode.replaceChild(newCheckAll, checkAllBox);

      newCheckAll.addEventListener("change", () => {
        toothCheckboxes.forEach((cb) => {
          cb.checked = newCheckAll.checked;
        });
      });
    }

    function updateNames(recordEl, index) {
      const inputs = recordEl.querySelectorAll("input, select");
      inputs.forEach((el) => {
        if (!el.name) return;
        el.name = el.name.replace(/_\d+$/, "_" + index);

        if (el.type === "checkbox" || el.type === "radio") {
          el.checked = false;
        } else {
          el.value = "";
        }
      });

      const indexLabel = recordEl.querySelector(".record-index");
      if (indexLabel) indexLabel.textContent = index + 1;

      wireCheckAll(recordEl);
    }

    // initialise first record
    wireCheckAll(recordsWrapper.querySelector(".odontogram-record"));

    addMoreBtn.addEventListener("click", () => {
      const firstRecord = recordsWrapper.querySelector(".odontogram-record");
      if (!firstRecord) return;

      const newRecord = firstRecord.cloneNode(true);
      recordIndex += 1;
      updateNames(newRecord, recordIndex);

      const removeBtn = newRecord.querySelector(".remove-record");
      if (removeBtn) {
        removeBtn.classList.remove("hidden");
        removeBtn.addEventListener("click", () => {
          newRecord.remove();
        });
      }

      recordsWrapper.appendChild(newRecord);
    });

    // keep first block non-removable
    const firstRemoveBtn = recordsWrapper.querySelector(".odontogram-record .remove-record");
    if (firstRemoveBtn) {
      firstRemoveBtn.classList.add("hidden");
    }
  });
</script>



  {% endblock %}
